<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>온라인 자선경매</title>
  <style>
    :root{
      --bg:#0f172a; /* slate-900 */
      --panel:#111827; /* gray-900 */
      --muted:#94a3b8; /* slate-400 */
      --text:#e5e7eb; /* gray-200 */
      --accent:#22d3ee; /* cyan-400 */
      --accent-2:#60a5fa; /* blue-400 */
      --danger:#f87171;
      --ok:#34d399;
      --card:#0b1220;
      --border:#1f2937;
    }
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg,#0b1020, #0f172a);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Pretendard,Malgun Gothic,Helvetica,Arial,sans-serif; line-height:1.45}
    a{color:var(--accent)}
    .container{max-width:1080px;margin:0 auto;padding:24px}
    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px}
    .title{font-size:28px;font-weight:800;letter-spacing:-0.5px}
    .badge{display:inline-flex;gap:6px;align-items:center;background:rgba(96,165,250,.12);border:1px solid rgba(96,165,250,.3);color:#c7d2fe;padding:6px 10px;border-radius:999px;font-size:12px}
    .grid{display:grid;grid-template-columns:1.1fr 1fr;gap:18px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:16px}
    .sub{color:var(--muted);font-size:13px}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    label{font-size:12px;color:#9ca3af}
    input[type=text], input[type=number], textarea, select{
      background:#0a0f1c;border:1px solid #1f2937;color:var(--text);
      padding:10px 12px;border-radius:10px;width:100%;
    }
    input[readonly]{opacity:.9}
    textarea{min-height:80px;resize:vertical}
    .btn{background:#0b1325;border:1px solid #1f2937;color:#e5e7eb;padding:10px 14px;border-radius:10px;cursor:pointer}
    .btn:hover{border-color:#334155}
    .btn.primary{background:linear-gradient(90deg, var(--accent), var(--accent-2));color:#011627;border:none}
    .btn.danger{background:rgba(248,113,113,.12);border:1px solid rgba(248,113,113,.35);color:#fecaca}
    .btn.ghost{background:transparent;border:1px dashed #334155;color:#cbd5e1}
    .hidden{display:none !important}
    .lot-list{display:flex;gap:12px;flex-wrap:wrap;margin:8px 0 4px}
    .chip{padding:8px 10px;border-radius:10px;border:1px solid #334155;background:#0a0f1c;cursor:pointer;font-size:13px}
    .chip.active{border-color:var(--accent);box-shadow:0 0 0 2px rgba(34,211,238,.25) inset}
    .meta-grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
    .attrs{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:10px}
    .price{font-size:24px;font-weight:800}
    .muted{color:#94a3b8;font-size:12px}
    .imgwrap{width:100%;aspect-ratio:1/1;background:#0a0f1c;border:1px dashed #334155;border-radius:12px;display:flex;align-items:center;justify-content:center;overflow:hidden}
    .imgwrap img{width:100%;height:100%;object-fit:contain}
    hr{border:none;border-top:1px solid #243247;margin:16px 0}
    .comment{padding:10px 12px;background:#0a0f1c;border:1px solid #1f2937;border-radius:12px;margin-bottom:10px}
    .comment strong{color:#e2e8f0}
    .comment .meta{font-size:11px;color:#94a3b8}
    .rules{font-size:13px;color:#a3b2c7}
    .flex{display:flex;gap:10px;align-items:center}
    .right{margin-left:auto}
    .pill{padding:4px 8px;border-radius:999px;background:#0f1a32;border:1px solid #2a3a57;font-size:11px;color:#cbd5e1}
    .footer{margin-top:12px;color:#64748b;font-size:12px}
    .kbd{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;background:#0f192f;border:1px solid #334155;border-bottom-color:#1f2937;padding:2px 6px;border-radius:6px}
  </style>
</head>
<body>
<div class="container">
  <header>
    <div class="title">온라인 자선경매</div>
    <div class="flex">
      <span class="badge">모드: <strong id="modeText">참가자</strong></span>
      <button class="btn" id="loginBtn">관리자 로그인</button>
      <button class="btn hidden" id="logoutBtn">로그아웃</button>
    </div>
  </header>

  <div class="card">
    <div class="row" style="justify-content:space-between;align-items:center">
      <div>
        <div style="font-weight:700;font-size:18px">경매 물품</div>
        <div class="sub">여러 물품(LOT)을 등록하고, 각 물품 페이지에서 댓글 입찰을 진행합니다.</div>
      </div>
      <div class="row">
        <button class="btn ghost" id="exportBtn" title="백업 JSON 내보내기 (관리자)">데이터 내보내기</button>
        <label class="btn ghost">
          데이터 가져오기 <input type="file" id="importFile" accept="application/json" hidden />
        </label>
        <button class="btn primary hidden" id="addLotBtn">새 물품 추가</button>
      </div>
    </div>

    <div class="lot-list" id="lotList"></div>
    <hr/>
    <div class="grid">
      <div class="card">
        <div class="imgwrap" id="imgWrap">
          <img id="lotImage" alt="상품 이미지 미리보기" />
        </div>
        <div id="adminImageControls" class="row hidden" style="margin-top:10px">
          <label class="btn">
            이미지 업로드
            <input type="file" id="imageInput" accept="image/*" hidden />
          </label>
          <button class="btn danger" id="removeImageBtn">이미지 제거</button>
        </div>
      </div>

      <div class="card">
        <div class="row" style="justify-content:space-between;align-items:center">
          <div style="font-weight:700;font-size:18px">물품 정보</div>
          <div class="row">
            <button class="btn hidden" id="editLotBtn">수정</button>
            <button class="btn danger hidden" id="deleteLotBtn">삭제</button>
          </div>
        </div>

        <div id="viewArea">
          <div class="meta-grid">
            <div>
              <div class="muted">제목</div>
              <div id="v_title" style="font-size:20px;font-weight:800"></div>
            </div>
            <div>
              <div class="muted">Ref. Price</div>
              <div id="v_refPrice"></div>
            </div>
          </div>
          <div class="attrs" style="margin-top:10px">
            <div><div class="muted">카테고리</div><div id="v_category"></div></div>
            <div><div class="muted">색상</div><div id="v_color"></div></div>
            <div><div class="muted">사이즈</div><div id="v_size"></div></div>
            <div><div class="muted">성별</div><div id="v_gender"></div></div>
            <div><div class="muted">상태</div><div id="v_condition"></div></div>
            <div><div class="muted">비고</div><div id="v_notes"></div></div>
          </div>
          <hr/>
          <div class="row" style="align-items:baseline">
            <div>
              <div class="muted">경매 시작가</div>
              <div class="price"><span id="v_startPrice">-</span> 원</div>
            </div>
            <div style="margin-left:24px">
              <div class="muted">현재 최고가</div>
              <div class="price" style="color:var(--accent)"><span id="v_currentBid">-</span> 원</div>
            </div>
            <div class="pill right" id="v_lotId"></div>
          </div>
        </div>

        <form id="editForm" class="hidden" autocomplete="off">
          <div class="row">
            <div style="flex:1">
              <label>제목</label>
              <input type="text" id="f_title" placeholder="예: BOUTIQUE MOSCHINO CARDIGAN (RED)" required />
            </div>
            <div style="width:180px">
              <label>Ref. Price (USD)</label>
              <input type="number" id="f_refPrice" step="1" min="0" placeholder="예: 560" />
            </div>
          </div>

          <div class="attrs" style="margin-top:8px">
            <div><label>카테고리</label><input type="text" id="f_category" placeholder="CARDIGAN" /></div>
            <div><label>색상</label><input type="text" id="f_color" placeholder="RED" /></div>
            <div><label>사이즈</label><input type="text" id="f_size" placeholder="MEDIUM" /></div>
            <div><label>성별</label><input type="text" id="f_gender" placeholder="FEMALE" /></div>
            <div><label>상태</label><input type="text" id="f_condition" placeholder="중고" /></div>
            <div><label>비고</label><input type="text" id="f_notes" placeholder="추가 정보" /></div>
          </div>

          <div class="row" style="margin-top:8px">
            <div style="width:200px">
              <label>시작가 (KRW)</label>
              <input type="number" id="f_startPrice" step="1000" min="0" required />
            </div>
            <div style="width:200px">
              <label>입찰단위 (KRW)</label>
              <input type="number" id="f_tick" step="1000" min="1000" value="1000" required />
            </div>
            <div class="right">
              <div class="muted">* 이미지 업로드는 좌측 패널에서</div>
            </div>
          </div>

          <div class="row" style="margin-top:12px;justify-content:flex-end">
            <button type="button" class="btn" id="cancelEdit">취소</button>
            <button type="submit" class="btn primary">저장</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <div class="grid" style="margin-top:18px">
    <div class="card">
      <div style="font-weight:700;font-size:18px">입찰 (댓글) 영역</div>
      <div class="rules" style="margin:6px 0 12px">
        1) 경매가는 <b>천원(₩1,000)</b> 단위로만 참여 가능합니다. 2) 댓글에 <b>숫자만</b> 적어주세요. 3) <b>이름(사번)</b>을 함께 입력해주세요.<br/>
        규칙을 준수하지 않은 댓글은 무효 처리될 수 있습니다.
      </div>

      <form id="bidForm" class="row" autocomplete="off">
        <div style="width:200px">
          <label>입찰가 (숫자만)</label>
          <input id="bidPrice" type="number" inputmode="numeric" placeholder="예: 10000" required />
        </div>
        <div style="flex:1">
          <label>이름(사번)</label>
          <input id="bidder" type="text" maxlength="30" placeholder="예: 곽준영(AW1036)" required />
        </div>
        <div style="width:160px;align-self:flex-end">
          <button class="btn primary" type="submit">입찰 등록</button>
        </div>
      </form>

      <hr/>
      <div id="comments"></div>
      <div class="footer">※ 개인정보 기재 시, 댓글 공개에 동의한 것으로 간주됩니다.</div>
    </div>

    <div class="card">
      <div style="font-weight:700;font-size:18px">도움말 & 설정</div>
      <div class="sub" style="margin-top:6px">
        - <b>관리자</b> 전용 기능: 물품 추가/수정/삭제, 이미지 업로드, 데이터 백업/복원<br/>
        - 참가자는 물품 정보를 읽기만 가능하며, <b>댓글을 통한 입찰</b>만 할 수 있습니다.<br/>
      </div>
      <hr/>
      <div>
        <div class="muted">현재 LOT</div>
        <div class="row">
          <div id="currentLotTitle" style="font-weight:700"></div>
          <span class="pill" id="currentLotId"></span>
        </div>
      </div>
      <hr/>
      <div class="sub">관리자 비밀키 변경은 코드 상단의 <span class="kbd">ADMIN_SECRET</span> 값을 수정하세요.</div>
    </div>
  </div>

  <div class="footer">© Charity Auction. LocalStorage에 데이터가 저장됩니다.</div>
</div>

<script>
  /***********************
   * 기본 저장/상태
   ***********************/
  const ADMIN_SECRET = "auction-2025-secret"; // <- 필요 시 변경하세요
  const $ = (sel)=>document.querySelector(sel);
  const fmt = (n)=> (n===null||n===undefined||n==='')?'-':n.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
  const nowStr = ()=> new Date().toLocaleString('ko-KR');

  function loadState(){
    const raw = localStorage.getItem('charityAuctionV1');
    if(!raw){
      // 초기 샘플 LOT 1개 생성
      const sample = {
        lots: [{
          id: crypto.randomUUID().slice(0,8).toUpperCase(),
          title: "BOUTIQUE MOSCHINO CARDIGAN (RED)",
          refPrice: 560,
          category:"CARDIGAN",
          color:"RED",
          size:"MEDIUM",
          gender:"FEMALE",
          condition:"중고",
          notes:"",
          startPrice: 20000,
          tick: 1000,
          currentBid: 5000,
          imageData: "", // 이미지 업로드 시 dataURL 저장
          comments: [] // {price, name, ts, valid}
        }],
        currentLotIdx: 0,
        isAdmin:false
      };
      localStorage.setItem('charityAuctionV1', JSON.stringify(sample));
      return sample;
    }
    return JSON.parse(raw);
  }
  function saveState(){ localStorage.setItem('charityAuctionV1', JSON.stringify(state)); }

  let state = loadState();

  /***********************
   * 로그인/로그아웃
   ***********************/
  function updateModeUI(){
    const isAdmin = !!state.isAdmin;
    $('#modeText').textContent = isAdmin ? '관리자' : '참가자';
    $('#addLotBtn').classList.toggle('hidden', !isAdmin);
    $('#editLotBtn').classList.toggle('hidden', !isAdmin);
    $('#deleteLotBtn').classList.toggle('hidden', !isAdmin);
    $('#adminImageControls').classList.toggle('hidden', !isAdmin);
    $('#loginBtn').classList.toggle('hidden', isAdmin);
    $('#logoutBtn').classList.toggle('hidden', !isAdmin);
    $('#exportBtn').classList.toggle('hidden', !isAdmin);
    // import label is visible always but only meaningful to admin
  }
  $('#loginBtn').addEventListener('click', ()=>{
    const k = prompt('관리자 비밀키를 입력하세요:');
    if(k===ADMIN_SECRET){
      state.isAdmin = true;
      saveState(); updateModeUI();
      alert('관리자 모드로 전환되었습니다.');
    } else if(k!==null){
      alert('비밀키가 올바르지 않습니다.');
    }
  });
  $('#logoutBtn').addEventListener('click', ()=>{
    state.isAdmin = false; saveState(); updateModeUI();
  });

  /***********************
   * LOT 렌더링/선택
   ***********************/
  function renderLotChips(){
    const list = $('#lotList');
    list.innerHTML = '';
    state.lots.forEach((lot,idx)=>{
      const el = document.createElement('button');
      el.className = 'chip' + (idx===state.currentLotIdx ? ' active' : '');
      el.textContent = `${idx+1}. ${lot.title}`;
      el.onclick = ()=>{ state.currentLotIdx = idx; saveState(); renderAll(); }
      list.appendChild(el);
    });
  }

  function currentLot(){ return state.lots[state.currentLotIdx]; }

  function renderLotView(){
    const lot = currentLot();
    if(!lot){ return; }
    $('#currentLotTitle').textContent = lot.title;
    $('#currentLotId').textContent = 'LOT ' + lot.id;
    $('#v_lotId').textContent = 'LOT ' + lot.id;

    $('#v_title').textContent = lot.title || '';
    $('#v_refPrice').textContent = lot.refPrice ? '$ ' + fmt(lot.refPrice) : '-';
    $('#v_category').textContent = lot.category || '-';
    $('#v_color').textContent = lot.color || '-';
    $('#v_size').textContent = lot.size || '-';
    $('#v_gender').textContent = lot.gender || '-';
    $('#v_condition').textContent = lot.condition || '-';
    $('#v_notes').textContent = lot.notes || '-';

    $('#v_startPrice').textContent = fmt(lot.startPrice || 0);
    $('#v_currentBid').textContent = fmt(lot.currentBid || 0);

    const img = $('#lotImage');
    if(lot.imageData){ img.src = lot.imageData; img.classList.remove('hidden'); }
    else { img.removeAttribute('src'); img.classList.add('hidden'); }

    renderComments();
  }

  function renderComments(){
    const lot = currentLot();
    const root = $('#comments');
    root.innerHTML = '';
    // 정렬: 최신순
    const list = [...(lot.comments||[])].sort((a,b)=> b.ts - a.ts);
    if(!list.length){
      const div = document.createElement('div');
      div.className='sub'; div.textContent='아직 댓글이 없습니다.';
      root.appendChild(div);
      return;
    }
    list.forEach(c=>{
      const div = document.createElement('div');
      div.className = 'comment';
      div.innerHTML = `<div class="row" style="justify-content:space-between">
        <strong>₩ ${fmt(c.price)}</strong>
        <span class="meta">${new Date(c.ts).toLocaleString('ko-KR')}</span>
      </div>
      <div class="meta">작성자: ${escapeHtml(c.name)}</div>`;
      root.appendChild(div);
    });
  }

  function escapeHtml(str){
    return (str||'').replace(/[&<>"']/g, (m)=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }

  /***********************
   * LOT 추가/수정/삭제
   ***********************/
  function openEdit(){
    const lot = currentLot();
    $('#viewArea').classList.add('hidden');
    $('#editForm').classList.remove('hidden');
    $('#editLotBtn').classList.add('hidden');

    $('#f_title').value = lot.title||'';
    $('#f_refPrice').value = lot.refPrice||'';
    $('#f_category').value = lot.category||'';
    $('#f_color').value = lot.color||'';
    $('#f_size').value = lot.size||'';
    $('#f_gender').value = lot.gender||'';
    $('#f_condition').value = lot.condition||'';
    $('#f_notes').value = lot.notes||'';
    $('#f_startPrice').value = lot.startPrice||0;
    $('#f_tick').value = lot.tick||1000;
  }
  function closeEdit(){
    $('#editForm').classList.add('hidden');
    $('#viewArea').classList.remove('hidden');
    $('#editLotBtn').classList.remove('hidden');
  }
  $('#editLotBtn').addEventListener('click', ()=> state.isAdmin && openEdit());
  $('#cancelEdit').addEventListener('click', closeEdit);
  $('#deleteLotBtn').addEventListener('click', ()=>{
    if(!state.isAdmin) return;
    if(confirm('이 물품을 삭제하시겠습니까?')){
      state.lots.splice(state.currentLotIdx,1);
      if(state.currentLotIdx>0) state.currentLotIdx--;
      saveState(); renderAll();
    }
  });
  $('#addLotBtn').addEventListener('click', ()=>{
    if(!state.isAdmin) return;
    const newLot = {
      id: crypto.randomUUID().slice(0,8).toUpperCase(),
      title: '새 물품',
      refPrice: null,
      category:'', color:'', size:'', gender:'', condition:'', notes:'',
      startPrice: 0, tick: 1000, currentBid: 0,
      imageData:'', comments:[]
    };
    state.lots.push(newLot);
    state.currentLotIdx = state.lots.length-1;
    saveState(); renderAll(); openEdit();
  });

  $('#editForm').addEventListener('submit', (e)=>{
    e.preventDefault();
    if(!state.isAdmin) return;
    const lot = currentLot();
    lot.title = $('#f_title').value.trim();
    lot.refPrice = parseInt($('#f_refPrice').value||'0',10) || null;
    lot.category = $('#f_category').value.trim();
    lot.color = $('#f_color').value.trim();
    lot.size = $('#f_size').value.trim();
    lot.gender = $('#f_gender').value.trim();
    lot.condition = $('#f_condition').value.trim();
    lot.notes = $('#f_notes').value.trim();
    lot.startPrice = parseInt($('#f_startPrice').value||'0',10) || 0;
    lot.tick = parseInt($('#f_tick').value||'1000',10) || 1000;
    if((lot.currentBid||0) < lot.startPrice){
      lot.currentBid = lot.startPrice;
    }
    saveState(); renderAll(); closeEdit();
  });

  // 이미지
  $('#imageInput').addEventListener('change', (e)=>{
    const file = e.target.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = (ev)=>{
      const lot = currentLot();
      lot.imageData = ev.target.result;
      saveState(); renderLotView();
    };
    reader.readAsDataURL(file);
    e.target.value = '';
  });
  $('#removeImageBtn').addEventListener('click', ()=>{
    const lot = currentLot();
    lot.imageData=''; saveState(); renderLotView();
  });

  /***********************
   * 입찰(댓글)
   ***********************/
  $('#bidForm').addEventListener('submit', (e)=>{
    e.preventDefault();
    const lot = currentLot();
    const price = parseInt($('#bidPrice').value||'0',10);
    const name = $('#bidder').value.trim();
    if(!price || !name){ alert('입력값을 확인하세요.'); return; }
    // 검증: 숫자, tick 단위, 현재 최고가 초과
    if(price % (lot.tick||1000) !== 0){
      alert(`입찰단위는 ${fmt(lot.tick||1000)}원 입니다.`); return;
    }
    const min = Math.max(lot.startPrice||0, lot.currentBid||0) + (lot.tick||1000) - ( (lot.currentBid||0) ? 0 : (lot.tick||1000) );
    if(price <= (lot.currentBid||lot.startPrice||0)){
      alert('현재 최고가보다 큰 금액을 입력해주세요.'); return;
    }
    // 등록
    lot.comments.push({price, name, ts: Date.now()});
    lot.currentBid = Math.max(lot.currentBid||0, price);
    saveState();
    $('#bidPrice').value='';
    renderLotView();
  });

  /***********************
   * 백업/복원
   ***********************/
  $('#exportBtn').addEventListener('click', ()=>{
    if(!state.isAdmin){ alert('관리자 전용 기능입니다.'); return; }
    const data = new Blob([JSON.stringify(state, null, 2)], {type:'application/json'});
    const url = URL.createObjectURL(data);
    const a = document.createElement('a');
    a.href = url; a.download = `auction-backup-${new Date().toISOString().slice(0,10)}.json`;
    document.body.appendChild(a); a.click(); a.remove();
    setTimeout(()=>URL.revokeObjectURL(url), 1000);
  });
  $('#importFile').addEventListener('change', (e)=>{
    if(!state.isAdmin){ alert('관리자 전용 기능입니다.'); e.target.value=''; return; }
    const file = e.target.files[0]; if(!file) return;
    const reader = new FileReader();
    reader.onload = (ev)=>{
      try{
        const obj = JSON.parse(ev.target.result);
        if(!obj || !Array.isArray(obj.lots)) throw new Error('형식 오류');
        state = obj; saveState(); renderAll();
        alert('데이터를 불러왔습니다.');
      }catch(err){
        alert('JSON 형식이 올바르지 않습니다.');
      }
    };
    reader.readAsText(file,'utf-8');
    e.target.value='';
  });

  /***********************
   * 렌더 합본
   ***********************/
  function renderAll(){
    updateModeUI();
    renderLotChips();
    renderLotView();
  }
  renderAll();
</script>
</body>
</html>
