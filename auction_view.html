<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Hansae Charity Auction – 입찰 페이지(참가자용)</title>
  <style>
    :root {
      --blue: #3182f6;
      --blue-soft: #e8f2ff;
      --bg: #f5f7fb;
      --text: #111827;
      --muted: #6b7280;
      --border: #e5e7eb;
      --card: #ffffff;
      --danger: #ef4444;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      background: radial-gradient(circle at top, #eef3ff 0, #f5f7fb 40%, #edf2ff 100%);
      color: var(--text);
      font-family: system-ui, -apple-system, BlinkMacSystemFont,
        "Apple SD Gothic Neo", "Malgun Gothic", sans-serif;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .app {
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    /* 상단 네비게이션 바 */
    .topbar {
      position: sticky;
      top: 0;
      z-index: 10;
      background: rgba(245, 247, 251, 0.9);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(229, 231, 235, 0.8);
    }

    .topbar-inner {
      max-width: 1080px;
      margin: 0 auto;
      padding: 14px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 10px;
      text-decoration: none;
      color: inherit;
      cursor: pointer;
    }

    .brand-logo {
      width: 32px;
      height: 32px;
      border-radius: 12px;
      background: linear-gradient(135deg, #3182f6, #4f46e5);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
      font-weight: 800;
      font-size: 17px;
    }

    .brand-text-main {
      font-weight: 700;
      font-size: 16px;
    }

    .brand-text-sub {
      font-size: 11px;
      color: var(--muted);
    }

    .pill {
      background: #eff4ff;
      color: #1d4ed8;
      padding: 4px 8px;
      border-radius: 999px;
      font-size: 11px;
      font-weight: 500;
    }

    /* 메인 레이아웃 */
    .main {
      flex: 1;
      display: flex;
      justify-content: center;
      padding: 24px 16px 32px;
    }

    .page-inner {
      width: 100%;
      max-width: 1080px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .card {
      width: 100%;
      background: var(--card);
      border-radius: 18px;
      border: 1px solid var(--border);
      box-shadow: 0 18px 45px rgba(15, 23, 42, 0.06);
      padding: 18px 18px 16px;
    }

    .card-header-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
      margin-bottom: 10px;
    }

    .card-title {
      font-size: 18px;
      font-weight: 700;
    }

    .card-subtitle {
      font-size: 12px;
      color: var(--muted);
      margin-top: 4px;
    }

    .badge-soft {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: var(--blue-soft);
      border-radius: 999px;
      padding: 4px 9px;
      font-size: 11px;
      color: #1d4ed8;
    }

    /* 버튼/폼 스타일 */
    .btn {
      border-radius: 999px;
      border: 1px solid var(--border);
      padding: 8px 12px;
      font-size: 12px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      text-decoration: none;
      background: #ffffff;
      color: var(--text);
      transition: transform 0.08s ease, box-shadow 0.1s ease,
        background 0.12s ease, border-color 0.12s ease;
      white-space: nowrap;
    }

    .btn:hover {
      background: #f3f4ff;
      border-color: #c7d2fe;
      transform: translateY(-0.5px);
      box-shadow: 0 4px 10px rgba(129, 140, 248, 0.15);
    }

    .btn-primary {
      background: linear-gradient(135deg, #3182f6, #4f46e5);
      color: #ffffff;
      border: none;
      box-shadow: 0 4px 12px rgba(79, 70, 229, 0.28);
      font-weight: 600;
    }

    .btn-ghost {
      background: #f9fafb;
      border-style: dashed;
    }

    label {
      font-size: 12px;
      color: var(--muted);
      display: block;
      margin-bottom: 2px;
    }

    input[type="text"],
    input[type="number"],
    textarea,
    select {
      background: #f9fafb;
      border: 1px solid var(--border);
      color: var(--text);
      padding: 8px 10px;
      border-radius: 12px;
      width: 100%;
      font-size: 13px;
      outline: none;
    }

    input[readonly] {
      background: #f3f4f6;
    }

    textarea {
      resize: vertical;
      min-height: 80px;
    }

    input:focus,
    textarea:focus,
    select:focus {
      border-color: var(--blue);
      box-shadow: 0 0 0 1px rgba(49, 130, 246, 0.12);
      background: #ffffff;
    }

    .row {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
    }

    .flex {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .right {
      margin-left: auto;
    }

    .muted {
      color: var(--muted);
      font-size: 12px;
    }

    .pill-soft {
      padding: 4px 8px;
      border-radius: 999px;
      background: #eff6ff;
      border: 1px solid #bfdbfe;
      font-size: 11px;
      color: #1e40af;
    }

    /* 레이아웃 그리드 */
    .grid-main {
      display: grid;
      grid-template-columns: 1.1fr 1fr;
      gap: 14px;
    }
    .grid-main-vertical {
      display: flex;
      flex-direction: column;
      gap: 14px;
    }

    .nickname-display {
      padding: 9px 12px;
      border-radius: 999px;
      background: #f3f4ff;
      border: 1px dashed #cbd5f5;
      font-size: 13px;
      color: #1f2937;
    }

    @media (max-width: 900px) {
      .grid-main {
        grid-template-columns: 1fr;
      }
    }

    /* LOT 리스트 (참가자 페이지에서는 사용 X지만 스타일 남겨둠) */
    .lot-list {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin: 10px 0 4px;
    }

    .chip {
      padding: 7px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: #f9fafb;
      cursor: pointer;
      font-size: 12px;
    }

    .chip.active {
      border-color: #4f46e5;
      background: #eef2ff;
      box-shadow: 0 0 0 1px rgba(79, 70, 229, 0.16);
      font-weight: 600;
    }

    /* 이미지 패널 */
    .imgwrap {
      width: 100%;
      aspect-ratio: 1 / 1;
      background: #eff4ff;
      border: 1px dashed #c7d2fe;
      border-radius: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }

    .imgwrap img {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }

    /* 물품 정보 패널 */
    .meta-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 10px;
      margin-top: 6px;
    }

    .attrs {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 8px;
      margin-top: 10px;
    }

    @media (max-width: 900px) {
      .attrs {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }

    .price-main {
      font-size: 22px;
      font-weight: 800;
    }

    .price-highlight {
      font-size: 22px;
      font-weight: 800;
      color: #2563eb;
    }

    .lot-id-pill {
      padding: 4px 8px;
      border-radius: 999px;
      background: #eff6ff;
      border: 1px solid #bfdbfe;
      font-size: 11px;
      color: #1e40af;
    }

    hr {
      border: none;
      border-top: 1px solid #e5e7eb;
      margin: 14px 0;
    }

    .hidden {
      display: none !important;
    }

    /* 댓글/입찰 카드 */
    .comment {
      padding: 10px 12px;
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      margin-bottom: 8px;
    }

    .comment strong {
      color: #111827;
    }

    .comment .meta {
      font-size: 11px;
      color: #9ca3af;
    }

    .rules {
      font-size: 12px;
      color: #4b5563;
    }

    footer {
      border-top: 1px solid #e5e7eb;
      background: #f9fafb;
      padding: 10px 20px 14px 20px;
      font-size: 11px;
      color: #9ca3af;
      margin-top: auto;
    }

    footer .inner {
      max-width: 1080px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
    }
  </style>
</head>
<body>
<div class="app">
  <!-- 상단 바 -->
  <div class="topbar">
    <div class="topbar-inner">
      <a href="catalog.html" class="brand">
        <div class="brand-logo">H</div>
        <div>
          <div class="brand-text-main">Hansae Charity Auction</div>
          <div class="brand-text-sub">온라인 자선경매 (댓글 입찰)</div>
        </div>
      </a>
      <div class="flex">
        <span id="nicknamePill" class="nickname-display">로그인 후 이용해 주세요</span>
        <button class="btn btn-ghost" id="logoutBtn" style="display:none;">로그아웃</button>
      </div>
    </div>
  </div>

  <!-- 메인 -->
  <main class="main">
    <div class="page-inner">
      <!-- 물품 상세 + 이미지 + 입찰/설정 -->
      <div class="grid-main">
        <!-- 좌측: 이미지 카드 -->
        <div class="card">
          <div class="card-header-row" style="margin-bottom:8px;">
            <div class="card-title">이미지 미리보기</div>
          </div>
          <div class="imgwrap" id="imgWrap">
            <img id="lotImage" alt="상품 이미지 미리보기" />
          </div>
        </div>

        <!-- 우측: 물품 정보 -->
        <div class="card">
          <div class="card-header-row">
            <div>
              <div class="card-title">물품 정보</div>
              <div class="card-subtitle">
                물품 정보는 관리자 페이지에서만 수정되며, 참가자는 읽기 전용입니다.
              </div>
            </div>
          </div>

          <!-- 표시 영역 -->
          <div id="viewArea">
            <div class="meta-grid">
              <div>
                <div class="muted">제목</div>
                <div id="v_title" style="font-size:18px;font-weight:800;"></div>
              </div>
              <div>
                <div class="muted">Ref. Price</div>
                <div id="v_refPrice"></div>
              </div>
            </div>

            <div class="attrs">
              <div>
                <div class="muted">카테고리</div>
                <div id="v_category"></div>
              </div>
              <div>
                <div class="muted">색상</div>
                <div id="v_color"></div>
              </div>
              <div>
                <div class="muted">사이즈</div>
                <div id="v_size"></div>
              </div>
              <div>
                <div class="muted">성별</div>
                <div id="v_gender"></div>
              </div>
              <div>
                <div class="muted">상태</div>
                <div id="v_condition"></div>
              </div>
              <div>
                <div class="muted">비고</div>
                <div id="v_notes"></div>
              </div>
            </div>

            <hr />

            <div class="row" style="align-items:baseline">
              <div>
                <div class="muted">경매 시작가</div>
                <div class="price-main"><span id="v_startPrice">-</span> 원</div>
              </div>
              <div style="margin-left:24px">
                <div class="muted">현재 최고가</div>
                <div class="price-highlight"><span id="v_currentBid">-</span> 원</div>
              </div>
              <div class="right">
                <span class="lot-id-pill" id="v_lotId"></span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- 입찰/도움말 카드 -->
      <div class="grid-main-vertical">
        <div class="card">
          <div class="card-title">입찰 (댓글) 영역</div>
          <div class="rules" style="margin:6px 0 10px;">
            1) 경매가는 <b>천원(₩1,000)</b> 단위로만 참여 가능합니다.<br />
            2) 댓글에는 <b>숫자만</b> 적어 주세요.<br />
            3) <b>닉네임</b>으로 입찰이 기록됩니다.<br />
            규칙을 지키지 않은 댓글은 무효 처리될 수 있습니다.
          </div>

          <form id="bidForm" class="row" autocomplete="off">
            <div style="width:200px; min-width:150px;">
              <label>입찰가 (숫자만)</label>
              <input
                id="bidPrice"
                type="number"
                inputmode="numeric"
                placeholder="예: 10000"
                required
              />
            </div>
            <div style="flex:1; min-width:180px;">
              <label>닉네임</label>
              <div id="bidderNicknameDisplay" class="nickname-display"></div>
              <input id="bidder" type="hidden" />
            </div>
            <div style="width:150px; align-self:flex-end;">
              <button class="btn btn-primary" type="submit">입찰 등록</button>
            </div>
          </form>

          <hr />
          <div id="comments"></div>
          <div class="muted" style="margin-top:6px;">
            ※ 개인정보 기재 시, 댓글 공개에 동의한 것으로 간주됩니다.
          </div>
        </div>

        <div class="card">
          <div class="card-title">도움말</div>
          <div class="card-subtitle" style="margin-top:6px;">
            · 이 화면은 <b>참가자용</b>으로, LOT 정보 수정·이미지 업로드는 불가능합니다.<br />
            · LOT 정보 등록/수정, 이미지 업로드, 백업/복원은 <b>관리자 페이지(charity_auction.html)</b>에서만 가능합니다.
          </div>
          <hr />
          <div>
            <div class="muted">현재 LOT</div>
            <div class="row" style="margin-top:4px;">
              <div id="currentLotTitle" style="font-weight:700;"></div>
              <span class="pill-soft" id="currentLotId"></span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <footer>
    <div class="inner">
      <span>© 2025 Hansae Charity Auction (Internal Prototype)</span>
      <span>모든 데이터는 이 브라우저의 LocalStorage에 저장됩니다.</span>
    </div>
  </footer>
</div>

<script>
  /***********************
   * 로그인/닉네임 관련
   ***********************/
  const USER_KEY = "charityAuctionUser";
  const USERS_LIST_KEY = "charityAuctionUsers";
  const PARTICIPANT_URL = "participant.html";

  const $ = (s) => document.querySelector(s);
  const fmt = (n) =>
    n === null || n === undefined || n === ""
      ? "-"
      : n.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");

  function loadCurrentUser() {
    const raw = localStorage.getItem(USER_KEY);
    if (!raw) return null;
    try {
      return JSON.parse(raw);
    } catch {
      return null;
    }
  }

  function loadPersistentNickname() {
    const raw = localStorage.getItem(USER_KEY);
    if (!raw) return null;

    let user;
    try {
      user = JSON.parse(raw);
    } catch {
      return null;
    }

    // 1) USER_KEY에 이미 nickname이 있는 경우
    if (user.nickname && typeof user.nickname === "string" && user.nickname.trim() !== "") {
      return user.nickname.trim();
    }

    // email 정보 없으면 더 이상 찾을 수 없음
    if (!user.email) return null;

    // 2) 가입자 리스트에서 nickname 찾아보기
    try {
      const rawList = localStorage.getItem(USERS_LIST_KEY);
      if (!rawList) return null;

      const list = JSON.parse(rawList);
      if (!Array.isArray(list)) return null;

      const found = list.find(
        (u) => u && u.email === user.email && typeof u.nickname === "string" && u.nickname.trim() !== ""
      );
      if (!found) return null;

      const nickname = found.nickname.trim();

      // 3) 찾은 nickname을 USER_KEY에도 다시 저장
      user.nickname = nickname;
      localStorage.setItem(USER_KEY, JSON.stringify(user));

      return nickname;
    } catch {
      return null;
    }
  }

  function applyNicknameToHeader() {
    const pill = document.getElementById("nicknamePill");
    const logoutBtn = document.getElementById("logoutBtn");
    if (!pill || !logoutBtn) return;

    const user = loadCurrentUser();
    const nickname = loadPersistentNickname();

    if (user && user.isLoggedIn && nickname) {
      pill.textContent = nickname + " 님";
      logoutBtn.style.display = "inline-flex";
    } else {
      pill.textContent = "로그인 후 이용해 주세요";
      logoutBtn.style.display = "none";
    }
  }

  /***********************
   * 경매 상태 로드
   ***********************/
  function loadState() {
    const raw = localStorage.getItem("charityAuctionV1");
    if (!raw) return null;
    try {
      return JSON.parse(raw);
    } catch {
      return null;
    }
  }

  function saveState(state) {
    localStorage.setItem("charityAuctionV1", JSON.stringify(state));
  }

  function escapeHtml(str) {
    return (str || "").replace(/[&<>\"']/g, (m) =>
      ({
        "&": "&amp;",
        "<": "&lt;",
        ">": "&gt;",
        '"': "&quot;",
        "'": "&#39;",
      }[m])
    );
  }

  /***********************
   * LOT 표시/코멘트
   ***********************/
  function currentLot(state) {
    return state.lots[state.currentLotIdx];
  }

  function renderComments(state) {
    const lot = currentLot(state);
    const root = $("#comments");
    if (!root) return;
    root.innerHTML = "";

    const list = [...(lot.comments || [])].sort((a, b) => b.ts - a.ts);
    if (!list.length) {
      const div = document.createElement("div");
      div.className = "muted";
      div.textContent = "아직 댓글이 없습니다.";
      root.appendChild(div);
      return;
    }

    list.forEach((c) => {
      const div = document.createElement("div");
      div.className = "comment";
      div.innerHTML = `
        <div class="row" style="justify-content:space-between;">
          <strong>₩ ${fmt(c.price)}</strong>
          <span class="meta">${new Date(c.ts).toLocaleString("ko-KR")}</span>
        </div>
        <div class="meta">작성자: ${escapeHtml(c.name)}</div>
      `;
      root.appendChild(div);
    });
  }

  function renderLotView(state) {
    const lot = currentLot(state);
    if (!lot) return;

    $("#currentLotTitle").textContent = lot.title || "";
    $("#currentLotId").textContent = "LOT " + lot.id;
    $("#v_lotId").textContent = "LOT " + lot.id;

    $("#v_title").textContent = lot.title || "";
    $("#v_refPrice").textContent = lot.refPrice ? "$ " + fmt(lot.refPrice) : "-";
    $("#v_category").textContent = lot.category || "-";
    $("#v_color").textContent = lot.color || "-";
    $("#v_size").textContent = lot.size || "-";
    $("#v_gender").textContent = lot.gender || "-";
    $("#v_condition").textContent = lot.condition || "-";
    $("#v_notes").textContent = lot.notes || "-";

    $("#v_startPrice").textContent = fmt(lot.startPrice || 0);
    $("#v_currentBid").textContent = fmt(lot.currentBid || 0);

    const img = $("#lotImage");
    if (img) {
      if (lot.imageData) {
        img.src = lot.imageData;
        img.classList.remove("hidden");
      } else {
        img.removeAttribute("src");
        img.classList.add("hidden");
      }
    }

    renderComments(state);
  }

  /***********************
   * URL의 lot 파라미터로 LOT 선택
   ***********************/
  function applyLotFromQuery(state) {
    const params = new URLSearchParams(window.location.search);
    const lotId = params.get("lot");
    if (!lotId) return;

    const idx = state.lots.findIndex((l) => l.id === lotId);
    if (idx >= 0) {
      state.currentLotIdx = idx;
    }
  }

  /***********************
   * 입찰 처리
   ***********************/
  function setupBidding(state, currentUser, currentNickname) {
    const bidForm = $("#bidForm");
    if (!bidForm) return;

    bidForm.addEventListener("submit", (e) => {
      e.preventDefault();
      const lot = currentLot(state);
      if (!lot) {
        alert("LOT 정보가 없습니다.");
        return;
      }

      const price = parseInt($("#bidPrice").value || "0", 10);
      const name = ($("#bidder").value || "").trim();

      if (!price) {
        alert("입찰가를 입력해 주세요.");
        return;
      }
      if (!currentUser || !currentUser.isLoggedIn || !currentNickname || !name) {
        alert("로그인 정보가 없어 입찰할 수 없습니다. 다시 로그인해 주세요.");
        window.location.href = PARTICIPANT_URL;
        return;
      }

      if (price % (lot.tick || 1000) !== 0) {
        alert(`입찰단위는 ${fmt(lot.tick || 1000)}원 입니다.`);
        return;
      }
      if (price <= (lot.currentBid || lot.startPrice || 0)) {
        alert("현재 최고가보다 큰 금액을 입력해 주세요.");
        return;
      }

      lot.comments = lot.comments || [];
      lot.comments.push({ price, name, ts: Date.now() });
      lot.currentBid = Math.max(lot.currentBid || 0, price);
      saveState(state);

      const priceInput = $("#bidPrice");
      if (priceInput) priceInput.value = "";
      renderLotView(state);
    });
  }

  /***********************
   * 초기 진입 처리
   ***********************/
  (function init() {
    // 로그인 체크
    let user = loadCurrentUser();
    const nickname = loadPersistentNickname();

    if (!user || !user.isLoggedIn || !nickname) {
      alert("로그인 후 이용해 주세요.");
      window.location.href = PARTICIPANT_URL;
      return;
    }

    // USER_KEY에도 nickname 확실히 저장
    if (!user.nickname || user.nickname !== nickname) {
      user.nickname = nickname;
      localStorage.setItem(USER_KEY, JSON.stringify(user));
    }

    applyNicknameToHeader();

    // 상단 로그아웃
    const logoutBtn = document.getElementById("logoutBtn");
    if (logoutBtn) {
      logoutBtn.addEventListener("click", () => {
        const u = loadCurrentUser();
        if (u) {
          u.isLoggedIn = false;
          localStorage.setItem(USER_KEY, JSON.stringify(u));
        }
        window.location.href = "homepage.html"; // 기존과 동일한 홈 파일명 사용
      });
    }

    // 입찰 영역 닉네임 반영
    const display = document.getElementById("bidderNicknameDisplay");
    const hiddenInput = document.getElementById("bidder");
    if (display) display.textContent = nickname + " 님";
    if (hiddenInput) hiddenInput.value = nickname;

    // 경매 상태 로드
    let state = loadState();
    if (!state || !Array.isArray(state.lots) || !state.lots.length) {
      alert("경매 물품 정보가 없습니다. 관리자에게 문의해 주세요.");
      return;
    }

    // URL의 lot 파라미터로 LOT 선택
    applyLotFromQuery(state);

    // 렌더링 및 입찰 설정
    renderLotView(state);
    setupBidding(state, user, nickname);
  })();
</script>
</body>
</html>
